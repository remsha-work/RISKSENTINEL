{% extends "base.html" %}
{% block title %}PM Dashboard - Risk Sentinel{% endblock %}

{% block extra_head %}
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
{% endblock %}

{% block content %}
<div class="dashboard-content p-4">
    <!-- HEADER (UNCHANGED) -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card p-5 border-0 shadow-lg rounded-4 bg-white">
                <div class="row align-items-center g-4">
                    <div class="col-lg-8">
                        <div class="d-flex align-items-center mb-3 mb-lg-0">
                            <div class="icon-circle me-4 p-3 shadow-sm" style="width: 70px; height: 70px; background: linear-gradient(135deg, #6b46c1, #9f7aea); border-radius: 16px;">
                                <i class="fas fa-chart-line text-white fs-2"></i>
                            </div>
                            <div>
                                <h1 class="h3 fw-bold mb-1" style="color: #6b46c1;">Project Management</h1>
                                <h1 class="h4 fw-bold mb-0" style="color: #6b46c1;">Dashboard</h1>
                            </div>
                        </div>
                        <p class="fs-5 fw-medium text-muted mb-0">Monitor projects, track progress, manage teams effectively.</p>
                    </div>
                    <div class="col-lg-4">
                        <button type="button" class="btn btn-purple w-100 py-3 fw-bold shadow-lg fs-5 h-100 d-flex align-items-center justify-content-center" 
                                data-bs-toggle="modal" data-bs-target="#createProjectModal" style="min-height: 70px;">
                            <i class="fas fa-plus me-2"></i>Create New Project
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI CARDS (UNCHANGED) -->
    <div class="row g-4 mb-5">
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="kpi-card h-100 p-4 rounded-3 shadow-lg border-0 text-center" style="background: linear-gradient(135deg, #6b46c1, #9f7aea); color: white;">
                <i class="fas fa-project-diagram fa-2x mb-3 opacity-75"></i>
                <div class="h2 fw-bold mb-2">{{ total_projects or 0 }}</div>
                <h6 class="fw-semibold mb-2">Total Projects</h6>
                <div class="progress mb-2" style="height: 6px;">
                    <div class="progress-bar bg-white" style="width: 75%"></div>
                </div>
                <small>Active projects</small>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="kpi-card h-100 p-4 rounded-3 shadow-lg border-0 text-center bg-success text-white">
                <i class="fas fa-tasks fa-2x mb-3 opacity-75"></i>
                <div class="h2 fw-bold mb-2">{{ total_tasks or 0 }}</div>
                <h6 class="fw-semibold mb-2">Total Tasks</h6>
                <small class="text-warning fw-bold">{{ overdue_tasks or 0 }} overdue</small>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="kpi-card h-100 p-4 rounded-3 shadow-lg border-0 text-center bg-info text-white">
                <i class="fas fa-dollar-sign fa-2x mb-3 opacity-75"></i>
                <div class="h2 fw-bold mb-2">‚Çπ{{ "%.0f"|format(((total_budget or 0) * 0.72)/1000)|int }}K</div>
                <h6 class="fw-semibold mb-2">Budget Used</h6>
                <small>72% utilized</small>
            </div>
        </div>
        <div class="col-xl-3 col-lg-6 col-md-6">
            <div class="kpi-card h-100 p-4 rounded-3 shadow-lg border-0 text-center bg-warning text-white">
                <i class="fas fa-users fa-2x mb-3 opacity-75"></i>
                <div class="h2 fw-bold mb-2">{{ team_members or 0 }}</div>
                <h6 class="fw-semibold mb-2">Team Members</h6>
                <small>Active team</small>
            </div>
        </div>
    </div>

    <!-- üî• RECENT PROJECTS WITH EDIT BUTTON -->
    <div class="row g-4">
        <div class="col-12">
            <div class="card shadow-xl border-0 overflow-hidden">
                <div class="card-header bg-white border-0 pb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0" style="color: #6b46c1;">
                            <i class="fas fa-list me-2"></i>Recent Projects
                        </h5>
                        <a href="/pm_projects" class="btn btn-outline-purple btn-sm px-3 py-1 fw-semibold">
    View All <i class="fas fa-arrow-right ms-1"></i>
</a>

                    </div>
                </div>
                <div class="card-body p-0">
                    {% if projects %}
                        {% for project in projects %}
                        <div class="project-item p-4 border-bottom" style="border-color: #e9ecef !important;">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6 class="fw-bold mb-1 text-dark">{{ project.name or 'Untitled' }}</h6>
                                    <div class="d-flex align-items-center gap-3 small text-muted">
                                        <span><i class="fas fa-calendar me-1"></i>{{ project.created_at.strftime('%b %d') if project.created_at else 'Recent' }}</span>
                                        {% if project.budget_total %}
                                        <span><i class="fas fa-rupee-sign me-1"></i>‚Çπ{{ "%.0f"|format((project.budget_total or 0)/1000)|int }}K</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-3 text-md-end">
                                    <span class="badge fs-6 px-3 py-2 fw-semibold 
                                        {% if project.status == 'Active' %}bg-success
                                        {% elif project.status == 'Planning' %}bg-info bg-opacity-25 text-info border border-info
                                        {% elif project.status == 'Completed' %}bg-success bg-opacity-25 text-success border border-success
                                        {% elif project.status == 'OnHold' %}bg-warning bg-opacity-25 text-warning border border-warning
                                        {% else %}bg-secondary
                                        {% endif %}">
                                        {{ project.status or 'Active' }}
                                    </span>
                                </div>
                                <div class="col-md-3 text-md-end">
                                    <!-- üî• 3 BUTTONS: VIEW + EDIT + DELETE -->
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewProject({{ project.project_id }})" title="View">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <!-- NEW EDIT BUTTON -->
                                        <button class="btn btn-sm btn-outline-warning me-1" onclick="editProjectStatus({{ project.project_id }}, '{{ project.status }}', '{{ project.name }}')" title="Update Status">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProject({{ project.project_id }}, '{{ project.name }}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-project-diagram fa-4x text-muted mb-4"></i>
                            <h5 class="text-muted fw-semibold mb-3">No projects yet</h5>
                            <p class="text-muted mb-4">Create your first project using the button above</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- QUICK ACTIONS (UNCHANGED) -->
 <!-- REAL DATA EXECUTIVE INSIGHTS -->
<div class="row mt-5">
    <div class="col-12">
        <h5 class="fw-bold mb-4" style="color: #6b46c1;">
            <i class="fas fa-chart-line me-2"></i>Project Overview
        </h5>
        <div class="row g-4">
            <!-- TOTAL ACTIVE PROJECTS -->
            <div class="col-xl-3 col-lg-6 col-md-6">
                <div class="card h-100 shadow-lg border-0 p-4 text-center">
                    <div class="icon-circle mb-3 p-3 mx-auto" style="width: 70px; height: 70px; background: linear-gradient(135deg, #6b46c1, #9f7aea);">
                        <i class="fas fa-project-diagram text-white fs-3"></i>
                    </div>
                    <h6 class="fw-bold mb-3" style="color: #6b46c1;">Active Projects</h6>
                    <div class="h3 fw-bold mb-2 text-success">{{ active_projects or 0 }}</div>
                    <small class="text-muted">of {{ total_projects or 0 }} total</small>
                </div>
            </div>

            <!-- PLANNING PROJECTS -->
            <div class="col-xl-3 col-lg-6 col-md-6">
                <div class="card h-100 shadow-lg border-0 p-4 text-center">
                    <div class="icon-circle mb-3 p-3 mx-auto" style="width: 70px; height: 70px; background: linear-gradient(135deg, #17a2b8, #20c997);">
                        <i class="fas fa-calendar-check text-white fs-3"></i>
                    </div>
                    <h6 class="fw-bold mb-3" style="color: #17a2b8;">Planning</h6>
                    <div class="h3 fw-bold mb-2 text-info">{{ planning_projects or 0 }}</div>
                    <small class="text-muted">Upcoming projects</small>
                </div>
            </div>

            <!-- COMPLETED PROJECTS -->
            <div class="col-xl-3 col-lg-6 col-md-6">
                <div class="card h-100 shadow-lg border-0 p-4 text-center">
                    <div class="icon-circle mb-3 p-3 mx-auto" style="width: 70px; height: 70px; background: linear-gradient(135deg, #28a745, #20c997);">
                        <i class="fas fa-check-circle text-white fs-3"></i>
                    </div>
                    <h6 class="fw-bold mb-3" style="color: #28a745;">Completed</h6>
                    <div class="h3 fw-bold mb-2 text-success">{{ completed_projects or 0 }}</div>
                    <small class="text-muted">Successfully finished</small>
                </div>
            </div>

            <!-- TOTAL BUDGET -->
            <div class="col-xl-3 col-lg-6 col-md-6">
                <div class="card h-100 shadow-lg border-0 p-4 text-center">
                    <div class="icon-circle mb-3 p-3 mx-auto" style="width: 70px; height: 70px; background: linear-gradient(135deg, #ffc107, #fd7e14);">
                        <i class="fas fa-rupee-sign text-white fs-3"></i>
                    </div>
                    <h6 class="fw-bold mb-3" style="color: #ffc107;">Total Budget</h6>
                    <div class="h3 fw-bold mb-2 text-warning">
                        {% if total_budget %}‚Çπ{{ "%.0f"|format((total_budget or 0)/1000)|int }}K{% else %}‚Çπ0{% endif %}
                    </div>
                    <small class="text-muted">Allocated budget</small>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Repeat for Team, Tasks, Reports with different icons/colors -->


<!-- üî• CREATE PROJECT MODAL (UNCHANGED - YOUR PERFECT SIZE) -->
<div class="modal fade clean-modal" id="createProjectModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <!-- YOUR PERFECT MODAL CONTENT HERE - SAME AS BEFORE -->
    <div class="modal-dialog modal-md modal-dialog-scrollable" style="max-width: 550px; margin-top: 120px !important;">
        <!-- ... YOUR EXISTING CREATE MODAL ... -->
    </div>
</div>

<!-- üî• NEW: QUICK STATUS UPDATE MODAL -->
<div class="modal fade status-update-modal" id="statusUpdateModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered" style="max-width: 400px; margin-top: 150px !important;">
        <div class="modal-content border-0 shadow-xl" style="border-radius: 16px;">
            <div class="modal-header bg-warning text-dark border-0" style="border-radius: 16px 16px 0 0; padding: 1.25rem;">
                <div class="d-flex align-items-center">
                    <i class="fas fa-edit fs-4 me-2 text-warning"></i>
                    <h6 class="modal-title mb-0 fw-bold">Update Project Status</h6>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="statusUpdateForm" novalidate>
                <div class="modal-body p-3">
                    <input type="hidden" name="project_id" id="editProjectId">
                    <div class="mb-3">
                        <label class="form-label fw-semibold small mb-1">Project</label>
                        <input type="text" id="editProjectName" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold small mb-2">New Status <span class="text-danger">*</span></label>
                        <select name="status" id="editStatus" class="form-select form-select-sm" required>
                            <option value="Planning">üó∫Ô∏è Planning</option>
                            <option value="Active">‚ñ∂Ô∏è Active</option>
                            <option value="OnHold">‚è∏Ô∏è On Hold</option>
                            <option value="Completed">‚úÖ Completed</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light p-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning btn-sm px-5 fw-bold shadow-sm">
                        <i class="fas fa-save me-1"></i>Update Status
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // üî• NEW: EDIT PROJECT STATUS
    const statusUpdateForm = document.getElementById('statusUpdateForm');
    if (statusUpdateForm) {
        statusUpdateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
            submitBtn.disabled = true;
            
            fetch('/update_project_status', { 
                method: 'POST', 
                body: formData 
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal')).hide();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(() => alert('Network error'))
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    }

    // üî• OPEN STATUS UPDATE MODAL
    window.editProjectStatus = function(projectId, currentStatus, projectName) {
        document.getElementById('editProjectId').value = projectId;
        document.getElementById('editProjectName').value = projectName;
        document.getElementById('editStatus').value = currentStatus;
        new bootstrap.Modal(document.getElementById('statusUpdateModal')).show();
    }

    // YOUR EXISTING FUNCTIONS (UNCHANGED)
    window.deleteProject = function(projectId, projectName) {
        if (confirm(`Delete "${projectName}"?`)) {
            fetch(`/delete_project/${projectId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Delete failed: ' + data.error);
                }
            })
            .catch(() => alert('Delete failed'));
        }
    }
    
    window.viewProject = function(projectId) {
        alert('View project ' + projectId + ' (feature coming soon)');
    }

    // YOUR CREATE PROJECT FORM (UNCHANGED - ADD IT HERE)
    // ... your existing createProjectModal code ...
});
</script>

<style>
/* YOUR ORIGINAL STYLES + NEW STATUS MODAL */
.modal-backdrop { display: none !important; }
.clean-modal, .status-update-modal { z-index: 99999 !important; }
.clean-modal .modal-dialog, .status-update-modal .modal-dialog { margin-top: 120px !important; }
.icon-circle { border-radius: 50% !important; display: flex; align-items: center; justify-content: center; }
.kpi-card { transition: all 0.3s ease; }
.kpi-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important; }
.action-card:hover { background: #f8f9fa !important; transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important; }
.bg-purple { background: linear-gradient(135deg, #6b46c1, #9f7aea) !important; color: white !important; }
.btn-purple { background: linear-gradient(135deg, #6b46c1, #9f7aea) !important; border: none !important; color: white !important; }
.btn-purple:hover { background: linear-gradient(135deg, #553c9a, #805ad5) !important; color: white !important; transform: translateY(-2px); }
.project-item:hover { background: #f8f9fa; border-radius: 12px; margin: 0 -12px; padding: 24px !important; }
.shadow-xl { box-shadow: 0 20px 40px rgba(0,0,0,0.12) !important; }
.btn-outline-purple { color: #6b46c1 !important; border-color: #6b46c1 !important; }
.btn-outline-purple:hover { background: #6b46c1 !important; color: white !important; }
</style>
{% endblock %}
