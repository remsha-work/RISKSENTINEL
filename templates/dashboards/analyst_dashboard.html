{% extends "base.html" %}
{% block title %}Risk Analytics Dashboard - Risk Sentinel{% endblock %}

{% block content %}
<!-- RISK ANALYTICS DASHBOARD - 4 TAB LAYOUT -->
<div class="dashboard-container p-6 bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
    
    <!-- HEADER + TABS -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">Risk Analytics Dashboard</h1>
        <p class="text-gray-600">Enterprise-wide risk monitoring & mitigation</p>
        
        <!-- 4 MAIN TABS -->
        <div class="flex bg-white rounded-xl shadow-lg mt-6 border">
            <a href="#overview" class="tab-btn px-6 py-3 font-semibold text-purple-600 border-b-4 border-purple-500 rounded-t-lg">Overview</a>
            <a href="#register" class="tab-btn px-6 py-3 font-semibold text-gray-600 hover:text-purple-600">Risk Register</a>
            <a href="#analytics" class="tab-btn px-6 py-3 font-semibold text-gray-600 hover:text-purple-600">Analytics</a>
            <a href="#reports" class="tab-btn px-6 py-3 font-semibold text-gray-600 hover:text-purple-600">Reports</a>
        </div>
    </div>

    <!-- TAB 1: OVERVIEW (Hero KPIs + Heatmap) -->
    <div id="overview" class="tab-content">
        <!-- 4 KPI CARDS -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="kpi-card bg-white p-6 rounded-2xl shadow-lg border-l-4 border-red-500">
                <h3 class="text-sm font-semibold text-gray-600">Total Risks</h3>
                <p class="text-3xl font-bold text-gray-900">{{ total_risks|default(127) }}</p>
            </div>
            <div class="kpi-card bg-white p-6 rounded-2xl shadow-lg border-l-4 border-yellow-500">
                <h3 class="text-sm font-semibold text-gray-600">High Priority</h3>
                <p class="text-3xl font-bold text-gray-900">{{ high_risks|default(23) }}</p>
            </div>
            <div class="kpi-card bg-white p-6 rounded-2xl shadow-lg border-l-4 border-orange-500">
                <h3 class="text-sm font-semibold text-gray-600">Avg Severity</h3>
                <p class="text-3xl font-bold text-gray-900">{{ avg_severity|default('7.4') }}</p>
            </div>
            <div class="kpi-card bg-white p-6 rounded-2xl shadow-lg border-l-4 border-green-500">
                <h3 class="text-sm font-semibold text-gray-600">Mitigated</h3>
                <p class="text-3xl font-bold text-gray-900">{{ mitigated|default(89) }}%</p>
            </div>
        </div>

        <!-- RISK HEATMAP CHART -->
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h3 class="text-xl font-bold mb-6">Risk Heatmap by Category</h3>
            <canvas id="riskHeatmap" width="800" height="400"></canvas>
        </div>
    </div>

    <!-- TAB 2: RISK REGISTER TABLE (Live from DB) -->
    <div id="register" class="tab-content hidden">
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Risk Register ({{ risks|length|default(0) }})</h3>
                <button class="add-risk-btn bg-purple-600 text-white px-6 py-2 rounded-xl hover:bg-purple-700">+ New Risk</button>
            </div>
            
            <!-- RISKS TABLE -->
            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-6 py-4 text-left">Risk ID</th>
                            <th class="px-6 py-4 text-left">Title</th>
                            <th class="px-6 py-4 text-left">Severity</th>
                            <th class="px-6 py-4 text-left">Status</th>
                            <th class="px-6 py-4 text-left">Project</th>
                            <th class="px-6 py-4 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for risk in risks %}
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-mono">#{{ risk.risk_id }}</td>
                            <td class="px-6 py-4">{{ risk.risk_title }}</td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold
                                    {% if risk.severity == 'High' %}bg-red-100 text-red-800
                                    {% elif risk.severity == 'Medium' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-green-100 text-green-800{% endif %}">
                                    {{ risk.severity }}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 rounded-full text-xs 
                                    {% if risk.status == 'Open' %}bg-orange-100 text-orange-800
                                    {% elif risk.status == 'Closed' %}bg-green-100 text-green-800
                                    {% else %}bg-blue-100 text-blue-800{% endif %}">
                                    {{ risk.status }}
                                </span>
                            </td>
                            <td class="px-6 py-4">{{ risk.project_name or 'N/A' }}</td>
                            <td class="px-6 py-4">
                                <button class="edit-btn text-blue-600 hover:text-blue-800 mr-2">Edit</button>
                                <button class="view-btn text-green-600 hover:text-green-800">View</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TABS 3 & 4: Analytics + Reports (PLACEHOLDERS FOR NOW) -->
    <div id="analytics" class="tab-content hidden">
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h3 class="text-2xl font-bold mb-6">Advanced Analytics</h3>
            <p>Chart.js graphs: Probability-Impact Matrix, Risk Velocity Trends</p>
        </div>
    </div>
    
    <div id="reports" class="tab-content hidden">
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h3 class="text-2xl font-bold mb-6">Reports & Exports</h3>
            <p>CSV Export, Audit Logs, Mitigation Tracking</p>
        </div>
    </div>
</div>

<!-- CHART.JS + CUSTOM JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('text-purple-600', 'border-purple-500'));
            btn.classList.add('text-purple-600', 'border-purple-500');
            document.querySelector(btn.getAttribute('href')).classList.remove('hidden');
        });
    });

    // Risk Heatmap Chart
    const ctx = document.getElementById('riskHeatmap').getContext('2d');
    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Risk Exposure',
                data: [
                    {x: 0.8, y: 0.9, r: 15}, // High risk
                    {x: 0.3, y: 0.7, r: 12},
                    {x: 0.6, y: 0.4, r: 10}
                ],
                backgroundColor: 'rgba(239, 68, 68, 0.6)'
            }]
        }
    });
</script>

<style>
    .tab-content { display: block; }
    .tab-content.hidden { display: none; }
    .kpi-card { transition: transform 0.2s; }
    .kpi-card:hover { transform: translateY(-4px); }
</style>
{% endblock %}
